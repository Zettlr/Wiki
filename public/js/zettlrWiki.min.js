/* zettlrWiki 2016-09-02 */
function MediaLibrary(a,b,c){this.filesToUpload=[],this.getterURL=a,this.setterURL=b,this.token=c,this.isReady=!1,this.dz=null,this.dzelement='<div class="dz-preview dz-image-preview">    <div class="dz-details">blablabla    <div class="dz-filename"><span data-dz-name></span></div>    <div class="dz-size" data-dz-size></div>    <img data-dz-thumbnail />    </div>    <div class="dz-progress"><span class="dz-upload" data-dz-uploadprogress></span></div>    <div class="dz-success-mark"><span>Ok</span></div>    <div class="dz-error-mark"><span>Error</span></div>    <div class="dz-error-message"><span data-dz-errormessage></span></div>    </div>',this.modal=$("<div></div>",{id:"media-library",html:'    <div id="tabs" style="height:100%;">                                                           <h1>Media library</h1>                                                                                                 <!-- Navigation -->                                                                                                    <div class="tab-nav">                                                                                                  <ul>                                                                                                               <li><a href="#media-library-content">Library</a></li>                                                          <li><a href="#media-library-upload">Upload files</a></li>                                                      </ul>                                                                                                              </div>                                                                                                                         <div class="tab" id="media-library-content">                                                                           <img src="/img/loading_spinner.gif" class="loading-spinner" id="loading-spinner" alt="Loading &hellip;">           </div>                                                                                                                         <!-- Second tab: Uploader -->                                                                                          <div class="tab" id="media-library-upload">                                                                            <div id="dropzone"></div>         </div>                                                                                                                 <div class="button-bar"><a class="button muted" id="media-library-upload-button">Upload files</a>        <a class="button error" id="media-library-close">Close</a></div>                               </div>'}).addClass("modal"),this.modal.style="display:none"}window.addEventListener("load",function(){var a=ContentTools.EditorApp.get();a.init("*[data-editable]","data-name",null,!1),a.addEventListener("saved",function(b){a.busy(!0),regions=b.detail().regions,newContents={_token:zettlrURL.csrfToken,title:$('[data-name="page-title"]').text(),content:regions["page-content"],slug:$('[data-name="page-content"]').attr("data-slug")},$.ajax({method:"POST",url:zettlrURL.contentToolsSetter,data:newContents,success:function(b){$.get(zettlrURL.contentToolsGetter+"/"+$('[data-name="page-content"]').attr("data-id"),function(){}).success(function(b){a.busy(!1),$('[data-name="page-content"]').html(b[0]),assembleTOC(),$("#contenttoolsEdit").html("<span>"+zettlrTrans.saveSuccess+"</span>").removeClass("warning").addClass("success").removeClass("editing"),$("#contenttoolsCancel").addClass("hidden"),$("#contenttoolsEdit span").first().fadeOut(1200,function(){$(this).text(zettlrTrans.editContentTools).fadeIn(100)})}).fail(function(a){new ContentTools.FlashUI("no")})},error:function(a){new ContentTools.FlashUI("no"),$("#contenttoolsEdit").text(zettlrTrans.saveFail).removeClass("warning").addClass("error")}})}),$("#contenttoolsEdit").on("click",function(){$(this).hasClass("editing")?($("#contenttoolsEdit").html('<span class="fa fa-cog fa-spin fa-lg"></span>').addClass("warning").removeClass("success"),a.stop(!0)):($("#contenttoolsEdit").html('<span class="fa fa-cog fa-spin fa-lg"></span>').addClass("warning").removeClass("success"),a.busy(!0),$.get(zettlrURL.contentToolsGetter+"/"+$('[data-name="page-content"]').attr("data-id")+"/raw",function(){}).success(function(b){$('[data-name="page-content"]').html(b[0]),a.syncRegions('[data-name="page-content"]'),a.busy(!1),a.start(),$("#contenttoolsEdit").html(zettlrTrans.saveChanges).addClass("success").removeClass("warning").addClass("editing"),$("#contenttoolsCancel").removeClass("hidden")}).fail(function(a){new ContentTools.FlashUI("no")}))}),$("#contenttoolsCancel").on("click",function(){$("#contenttoolsEdit").hasClass("editing")&&($("#contenttoolsCancel").html('<span class="fa fa-cog fa-spin fa-lg"></span>').addClass("warning").removeClass("error"),a.busy(!0),a.stop(!1),$.get(zettlrURL.contentToolsGetter+"/"+$('[data-name="page-content"]').attr("data-id"),function(){}).success(function(b){$('[data-name="page-content"]').html(b[0]),a.busy(!1),$("#contenttoolsEdit").html(zettlrTrans.editContentTools).removeClass("editing"),$("#contenttoolsCancel").addClass("hidden").removeClass("warning").addClass("error").html(zettlrTrans.cancel),assembleTOC()}).fail(function(a){new ContentTools.FlashUI("no")}))})});var decodeHtmlEntity=function(a){return a.replace(/&#(\d+);/g,function(a,b){return String.fromCharCode(b)})},encodeHtmlEntity=function(a){for(var b=[],c=a.length-1;c>=0;c--)b.unshift(["&#",a[c].charCodeAt(),";"].join(""));return b.join("")},assembleTOC=function(){$(".toc-parent").length&&$(".toc-parent").remove(),$("#toc-toggle").length&&$("#toc-toggle").first().parent().remove();var a=[],b=0;if($("#wikitext").find("*").each(function(){$(this).prop("tagName").match(/^h[1-6]$/i)&&(txt=encodeHtmlEntity($(this).text()),a.push('<li class="class-'+$(this).prop("tagName").toLowerCase()+'"><a href="#heading'+b+'" title="'+txt+'" class="toc-link">'+txt+"</a></li>"),$(this).prepend('<a name="heading'+b+'" class="anchor"></a>'),b++)}),a.length>0){for(mydiv=$("body").append('<div class="toc-parent"><div class="toc" id="toc"><ul></ul></div></div>'),mydiv=$("#toc ul"),$("nav.nav ul").prepend('<li><a id="toc-toggle" role="button" aria-label="Toggle Navigation" class="lines-button"><span class="lines"></span></a></li>'),b=0;b<a.length;b++)mydiv.append(a[b]);$(".toc-parent").addClass("back"),$("#toc-toggle").click(function(){$(this).hasClass("open")?($("#toc").removeClass("open"),$("#toc-toggle").removeClass("open"),$(".toc-parent").addClass("back")):($(".toc-parent").removeClass("back"),$("#toc").addClass("open"),$(this).addClass("open"))}),$("#toc").click(function(){$("#toc-toggle").click()}),$(".toc-link").mouseover(function(){ttipid="ttip-"+$(this).attr("href").substring(1),ttipcontent=$(this).attr("title"),ttipelem=$('<div class="tooltip left" id="'+ttipid+'">'+ttipcontent+"</div>"),ttipelem.css("top",$(this).offset().top-4),ttipelem.css("left",$(this).offset().left+$(this).outerWidth()+10),$("body").append(ttipelem).fadeIn("fast")}),$(".toc-link").mouseout(function(){ttipid="ttip-"+$(this).attr("href").substring(1),$("#"+ttipid).each(function(){$(this).fadeOut("fast",function(){$(this).remove()})})})}};MediaLibrary.prototype.init=function(){this.on("addedfile",function(a){titleElem=Dropzone.createElement('<input type="text" placeholder="Title" title="The file title" value="'+a.name+'" class="dz-img-info title-input-field" name="title[]">'),a.previewElement.appendChild(titleElem),descElem=Dropzone.createElement('<input type="text" title="The file description" placeholder="Description" class="dz-img-info" name="description[]">'),a.previewElement.appendChild(descElem),clearElem=Dropzone.createElement('<div style="clear:both;"></div>'),a.previewElement.appendChild(clearElem);var b=this;titleElem.addEventListener("keypress",function(a){b.isReady=!0,$(".title-input-field").each(function(){""===$(this).val()&&(b.isReady=!1)}),b.isReady?($("#media-library-upload-button").removeClass("muted"),$("#media-library-upload-button").addClass("success")):($("#media-library-upload-button").removeClass("success"),$("#media-library-upload-button").addClass("muted"))}),$(".title-input-field").trigger("keypress")})},MediaLibrary.prototype.show=function(){$("body").addClass("dim"),$("body").append(this.modal),$("#media-library").show(),$(document).keydown($.proxy(function(a){27==a.which&&this.close(a)},this)),$("#media-library-close").click($.proxy(this.close,this)),$("head").append('<script src="js/dropzone.js" id="dzjs"></script>'),this.dz=new Dropzone("div#dropzone",{url:this.setterURL,paramName:"file",maxFilesize:8,uploadMultiple:!0,addRemoveLinks:!0,clickable:!0,acceptedFiles:"image/jpg,image/jpeg,image/png,image/gif,image/svg,image/bmp",autoProcessQueue:!1,previewElement:this.dzelement,init:this.init}),$("#media-library").tabs(),$("#media-library-upload-button").hide(),$(".tab-nav").bind("click",function(a){1==$("#media-library").tabs("option","active")?$("#media-library-upload-button").show():$("#media-library-upload-button").hide()});var a=this;$("#media-library-upload-button").click(function(b){$(this).is(":visible")&&a.dz.isReady&&a.dz.processQueue()}),this.dz.on("sending",function(a,b,c){c.append("userName","bob")})},MediaLibrary.prototype.close=function(a){$("#media-library").is(":visible")&&($("body").removeClass("dim"),$("#media-library").remove(),$("#dzjs").remove())},MediaLibrary.prototype.getMedia=function(){$.get(this.getterURL,function(){}).done(function(a){for(var b=0;b<a.responseJSON.length;b++);}).fail(function(a){$("#media-library-content").html('<div class="alert primary">'+a.responseJSON.message+"</div>")})},MediaLibrary.prototype.processSelection=function(){this.validate&&this.dz.processQueue()},MediaLibrary.prototype.validate=function(a){return console.log("Validating ..."),disabled=!0,$(".media-library-file").each(function(){}),disabled?$("#media-library-submit").attr("disabled","disabled"):$("#media-library-submit").removeAttr("disabled"),!1};